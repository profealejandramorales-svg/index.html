<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia y Calificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos específicos para la impresión */
        @media print {
            body {
                background-color: #fff;
            }
            .no-print {
                display: none !important;
            }
            .printable-container {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            /* Asegura que los títulos y tablas se vean bien en la impresión */
            .printable-container h1, .printable-container h2 {
                text-align: center;
                margin-bottom: 2rem;
            }
            .printable-container table {
                width: 100%;
            }
            .printable-container .shadow-md, .printable-container .rounded-lg {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="printable-container bg-white p-8 rounded-2xl shadow-xl max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center no-print">Control de Asistencia y Calificaciones</h1>
        <p class="text-gray-500 mb-6 text-center no-print">Gestión de estudiantes, notas, asistencia y observaciones.</p>
        <p id="currentDate" class="text-gray-600 text-center mb-6 no-print"></p>

        <div class="no-print text-center mb-4">
            <p class="text-sm text-gray-500">
                <span id="userIdDisplay" class="font-mono text-blue-600 font-semibold break-all">Cargando...</span>
                <br>
                <span id="statusDisplay" class="text-xs font-medium mt-1"></span>
            </p>
        </div>

        <div class="no-print mb-8 space-y-4 md:space-y-0 md:flex md:justify-between md:items-end">
            <div class="flex-1 mr-4">
                <label for="classSelector" class="block text-gray-700 font-semibold mb-2">Seleccionar Clase</label>
                <select id="classSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </select>
            </div>
            
            <div class="flex-1 mr-4">
                <label for="dateSelector" class="block text-gray-700 font-semibold mb-2">Seleccionar Fecha</label>
                <input type="date" id="dateSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>
            
            <div class="flex-1 md:flex-none md:w-auto md:ml-4">
                <label for="studentNameInput" class="block text-gray-700 font-semibold mb-2">Agregar Estudiante</label>
                <div class="flex">
                    <input type="text" id="studentNameInput" placeholder="Ej: Juan Pérez"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    <button id="addStudentBtn"
                        class="ml-2 bg-green-500 text-white font-bold py-2.5 px-4 rounded-lg shadow-md hover:bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                        +
                    </button>
                </div>
            </div>
        </div>

        <div id="studentsTableContainer" class="min-h-[200px] flex items-center justify-center printable-container">
            <div id="loadingIndicator" class="text-gray-500 text-center flex flex-col items-center gap-2">
                <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Cargando datos...</p>
            </div>
        </div>

        <div class="no-print mt-8 text-center space-y-4 md:space-x-4">
            <button id="printCurrentViewBtn"
                class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Imprimir Vista Actual
            </button>
            <button id="generateReportBtn"
                class="w-full md:w-auto bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                Generar Reporte de Clases
            </button>
        </div>

        <div id="classReportContainer" class="hidden mt-8 printable-container">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Resumen de Clases</h2>
            <div id="classReportContent"></div>
            <div class="text-center mt-4 no-print">
                <button id="printReportBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Imprimir Reporte
                </button>
                <button id="hideReportBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Volver a la tabla</button>
            </div>
        </div>

        <div id="classDetailsContainer" class="hidden mt-8 printable-container">
            <h2 id="classDetailsTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
            <div id="classDetailsContent"></div>
            <div class="text-center mt-4 no-print">
                <button id="printDetailsBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Imprimir Reporte Detallado
                </button>
                <button id="backToReportBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Volver al Resumen</button>
            </div>
        </div>
        
        <div id="observationModal" class="no-print fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-800">Observaciones para...</h2>
                    <button id="closeObservationModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <textarea id="observationTextarea" rows="4" placeholder="Escribe tus observaciones aquí..."
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button id="saveObservationBtn"
                    class="mt-4 w-full bg-blue-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Guardar
                </button>
            </div>
        </div>

        <div id="messageModal" class="no-print fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="messageTitle" class="text-xl font-bold text-gray-800"></h2>
                    <button id="closeMessageModalBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <p id="messageContent" class="text-gray-600 mb-4"></p>
                <div id="messageButtons" class="flex justify-end gap-2">
                    <button id="confirmBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hidden">Confirmar</button>
                    <button id="cancelBtn" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hidden">Cancelar</button>
                    <button id="okBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hidden">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establece el nivel de log para depuración de Firestore
        // setLogLevel('debug'); // Descomenta solo si necesitas ayuda con la conexión

        // --- TU CONFIGURACIÓN DE FIREBASE PERSONAL AQUÍ ---
        // PEGA EL OBJETO 'const firebaseConfig = { ... }' DE TU PROYECTO FIREBASE PERSONAL Y ACTIVO.
        const firebaseConfig = {
  apiKey: "AIzaSyAFp6biz1UTr9Ehaudkpe7QyTFVbdQz5Sc",
  authDomain: "asistencia-mi-clase.firebaseapp.com",
  projectId: "asistencia-mi-clase",
  storageBucket: "asistencia-mi-clase.firebasestorage.app",
  messagingSenderId: "552398254230",
  appId: "1:552398254230:web:c58dd07e5ceeb67e0912b7",
  measurementId: "G-MYR01HM1YE"
};
        // --------------------------------------------------
        
        // --- Application State ---
        let app, db, auth;
        let isFirebaseConnected = false;
        const today = new Date();
        const todayString = today.toISOString().slice(0, 10);
        let currentDateString = todayString; 
        let allClassesData = {}; 
        let currentClass = null; 
        let students = []; 
        let userId; 
        let currentStudentIndex = -1; 
        let currentClassReport = null; 

        // --- DOM Elements ---
        const studentNameInput = document.getElementById('studentNameInput');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentsTableContainer = document.getElementById('studentsTableContainer');
        const currentDateDisplay = document.getElementById('currentDate');
        const observationModal = document.getElementById('observationModal');
        const modalTitle = document.getElementById('modalTitle');
        const observationTextarea = document.getElementById('observationTextarea');
        const saveObservationBtn = document.getElementById('saveObservationBtn');
        const closeObservationModalBtn = document.getElementById('closeObservationModalBtn');
        const classSelector = document.getElementById('classSelector');
        const dateSelector = document.getElementById('dateSelector'); 
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');
        const messageButtons = document.getElementById('messageButtons');
        const okBtn = document.getElementById('okBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeMessageModalBtn = document.getElementById('closeMessageModalBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const classReportContainer = document.getElementById('classReportContainer');
        const classReportContent = document.getElementById('classReportContent');
        const classDetailsContainer = document.getElementById('classDetailsContainer');
        const classDetailsTitle = document.getElementById('classDetailsTitle');
        const classDetailsContent = document.getElementById('classDetailsContent');
        const printCurrentViewBtn = document.getElementById('printCurrentViewBtn');
        const printReportBtn = document.getElementById('printReportBtn');
        const printDetailsBtn = document.getElementById('printDetailsBtn');
        const hideReportBtn = document.getElementById('hideReportBtn');
        const backToReportBtn = document.getElementById('backToReportBtn');

        // --- Datos de prueba para el modo local ---
        const initialClassData = {
            'Primero Medio A': [
                'ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABALÓN BELTRÁN BENJAMÍN NICOLÁS',
                'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUSTÍN ALEXIS',
                'HERNÁNDEZ FERNÁNDEZ DHARIEN ALEXSANDER', 'IBÁÑEZ GONZÁLEZ FERNANDA MAGDALENA',
                'LAGOS LASTRA ALEXANDRA DANAE', 'LÓPEZ LÓPEZ LUCIANO ANTONIO',
                'MALDONADO FLORES ANTONELLA BELÉN', 'MARIN MARÍN IGNACIO ANTONIO',
                'MONTECINO DÍAZ VALESKA BELÉN', 'MUÑOZ CONTRERZ LUIS GABRIEL',
                'MUÑOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ',
                'ORELLANA ARRIAGADA SEBASTIÁN ANDRÉS', 'QUEZADA NARANJO FELIPE ALONSO',
                'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAMÍREZ VILLALOBOS DUVAN EMILIO',
                'SANTANDER LÓPEZ MARÍA JOSÉ', 'TAPIA CASTILLA JEANFRANCO PATRICK',
                'URBINA CÁCERES FRANCHESCA POULETTE', 'VÁSQUEZ ZALDUENDO AMANDA ISABEL',
                'ZABALAGA COFRÉ DAMIÁN ANDRÉS', 'BAEZ DONOSO LUKAS ALFONSO',
                'MESA DÍAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'
            ],
            'Primero Medio B': [
                'ARAYA DOMÍNGUEZ NOEMÍ JESÚS DE LAS ESTRELLAS', 'ASTUDILLO CAMPOS CRISTÓBAL ANTONIO',
                'ASTUDILLO VÁSQUEZ BRUNO FERNANDO LEÓN', 'CASTILLO MUÑOZ RENÉ ANTONIO',
                'CID CERDA MARÍA EVANGELINA', 'CUMINAO VIDAL CATALINA ANDREA',
                'DÍAZ MALUENDA MIGUEL ALBERTO', 'KILTAN GONZÁLEZ DIDIER EZEQUIEL',
                'LÓPEZ ACUÑA MARCO EMILIO', 'LÓPEZ NOVOA EYDAN DAMIÁN',
                'MÉNDEZ SUAZO FABIÁN FELIPE', 'MOYA REYES MATEO ANTONIO BENJAMÍN',
                'OSES CAMPOS VALENTINA ABIGAIL', 'PALMA ORELLANA ANTONELLA FRANCISCA',
                'PEREIRA ORELLANA MONSERRAT ALAMIRA', 'PÉREZ ORMAZÁBAL ZADKA ALEJANDRA',
                'ROJAS GONZÁLEZ FLORENCIA TRINIDAD', 'ROJAS LEIVA EDUARDO JAVIER',
                'VÁSQUEZ AGUILERA SCARLET NICOLE', 'YÁÑEZ GONZÁLEZ BRAYAN DAMIÁN',
                'VARGAS MORAGA MARTINA SAYEN', 'SALAZAR SALAS PEDRO JOSÉ',
                'VERA BRAVO FLORENCIA ANTONIA', 'PÉREZ QUEVEDO CONSTANZA TRINIDAD',
                'SALGADO TOLEDO FRANCISCO JAVIER', 'RIQUELME SANTOS BENJAMÍN ALONSO'
            ],
            'Segundo Medio A': [
                'AHUMADA ROJAS TRINIDAD BELÉN', 'ESPINOSA TORRES FERNANDA ELENA',
                'ESPINOZA PEÑALILLO BRAYAN JESÚS', 'GONZÁLEZ SALAZAR EMILIA CATALINA',
                'MEDEL OJEDA LEÓN IGNACIO', 'MORALES REIMÁN ALFONSO TOMÁS',
                'PEREIRA HORMAZÁBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORDÁN AMARO',
                'RECABAL YÁÑEZ KEVIN ANDRÉS', 'RIQUELME CASTILLO MATÍAS EDUARDO ANTONIO',
                'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT',
                'SOBARZO YÉVENES KATHERINNE ALEXIA BELÉN', 'TOLEDO ALBORNOZ ANTONELLA INES',
                'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL',
                'MEZA COLIMÁN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'
            ],
            'Segundo Medio B': [
                'ARAYA DOMÍNGUEZ ALEX FABIÁN', 'BRAVO MENARES ALEX JOHAN',
                'CARRASCO LEIVA BENJAMÍN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)',
                'ENCINA PIZARRO DIEGO BENJAMÍN ALEXANDER', 'FAÚNDEZ NORAMBUENA ALEJANDRO ANTONIO',
                'JARAMILLO VILLAR EMILIO SCOTT', 'LÓPEZ VILLAR MARTÍN ALONSO',
                'MIRANDA MUÑOZ ALEXANDRA JAVIERA', 'MUÑOZ TRONCOSO HÉCTOR ANTONIO',
                'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA',
                'ORELLANA GARRIDO MATÍAS LEANDRO', 'PUNOY MEDEL MILLARAY ANGÉLICA',
                'QUIÑENAO MUÑOZ CRISTÓBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA',
                'SALGADO ROJAS VICENTE MOISÉS', 'SANDOVAL CERPA VICENTE ESTEBAN',
                'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MARTÍN'
            ],
            'Tercero Medio A': [
                'ALCÁNTAR GARCÍA MARTINA ALEJANDRA', 'BAHAMONDE MUÑOZ ARIEL LEON',
                'CAMPOS MUÑOZ CRISTOPHER JESÚS', 'CANCINO ORÓSTICA VICENTE GASPAR',
                'CARRASCO GONZÁLEZ CAMILA ANDREA', 'COFRÉ CASTILLO ANTONIO ANDRÉS',
                'CONTRERAS VENEGAS BELÉN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN',
                'GARCÍA GONZÁLEZ SANTIAGO HUMBERTO', 'GONZÁLEZ AMIGO FRANCISCA IGNACIA',
                'GONZÁLEZ SALAZAR JOAQUÍN ALONSO', 'GUTIÉRREZ GUTIÉRREZ ANGEL MARTÍN',
                'JARA SEPÚLVEDA KATRINA DARINKA', 'MARTÍNEZ LIZANA AARON ALEJANDRO',
                'MEZA CARRASCO BENJAMÍN INTI', 'MIÑO GONZALEZ CATALINA ANDREA',
                'MORAGA PACHECO RENATO IGNACIO', 'PÉREZ CORÓN MANUEL IGNACIO',
                'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEPÚLVEDA SALAZAR SOFÍA ANTONIA',
                'TAPIA ACUÑA GABRIEL ANTONIO', 'VEGA VIVANCO CRISTÓBAL ANTONIO',
                'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA',
                'VILLALOBOS VILLALOBOS SAMIR LUCIAN JESÚS', 'HERNÁNDEZ SEPÚLVEDA VICENTE ALEJANDRO',
                'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA',
                'LOBOS CÁCERES ANTONIA PAZ'
            ],
            'Tercero Medio C': [
                'ARELLANO ACUÑA MARTÍN ANTONIO', 'AROS ÁVILA DAYANA IGNACIA',
                'CABRERA COLOMBINO MARÍA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA',
                'GÓMEZ CANCINO DANIELA ALEJANDRA', 'GUTIÉRREZ CARRIÓN MILLARAY CAROLINA',
                'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAMÍN ESTEBAN',
                'PALACIOS SOTO JOSÉ TOMÁS', 'PEZO SANTANDER JOSÉ CRISTÓBAL',
                'ROCHA ROJAS JOSÉ PABLO WILLIAMS', 'ROJAS YÉVENES FABIANA ISIDORA',
                'SÁNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER LÓPEZ SIMÓN ESTEBAN',
                'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA',
                'DE LA HOZ VALENZUELA FRANCO SEBASTIÁN', 'COLLAO MEDINA ANAÍS VALENTINA'
            ],
            'Cuarto Medio A': [
                'AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN',
                'FUENTES GONZÁLEZ ESTEBAN ALEXANDER', 'GARCÍA ROJAS SOFÍA ELENA',
                'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZÁLEZ CASTRO KEVIN ALEJANDRO',
                'MARCHANT MORÁN PÍA IGNACIA', 'QUINTANA SAN MARTÍN ALAN VICENTE',
                'RECABAL YÁÑEZ CRISTOFER BASTIÁN', 'ROJAS GONZÁLEZ GABRIEL ANTONIO',
                'TOLEDO MUÑOZ ESPERANZA BELÉN', 'YÁÑEZ GONZÁLEZ FRANCISCA ALEJANDRA'
            ],
            'Cuarto Medio C': [
                'Josefa Morales', 'Benjamín Pérez', 'Constanza Varela'
            ],
        };

        // --- Funciones de Utilidad (CORREGIDA: Ruta limpia de Firestore) ---
        
        /**
         * Obtiene la referencia al documento de Firestore para el usuario actual.
         */
        function getDataDocRef() {
            // RUTA CORREGIDA: Usa una colección simple llamada 'teachers_data'
            const dataPath = `teachers_data/${userId}`; 
            return doc(db, dataPath);
        }

        // Función de utilidad para calcular el promedio (se mantiene igual)
        function calculateAverage(grades) {
            if (!grades || grades.length === 0) return 0.0;
            const sum = grades.reduce((a, b) => a + b, 0);
            return sum / grades.length;
        }

        // Función de utilidad para obtener el estado de asistencia (se mantiene igual)
        function getAttendanceStatus(student) {
            if (student.attendance && student.attendance[currentDateString]) {
                return student.attendance[currentDateString];
            }
            return { status: 'N/A', observation: '' };
        }

        // Función de utilidad para formatear la fecha (se mantiene igual)
        function updateCurrentDate() {
            const dateObj = new Date(currentDateString);
            currentDateDisplay.textContent = `Fecha Seleccionada: ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        }

        // --- Funciones Principales ---
        
        /**
         * Initializes Firebase or falls back to local mode.
         * @async
         */
        async function initApp() {
            // Verifica si la configuración de Firebase tiene la clave API (la señal de que el usuario la pegó)
            if (firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5) {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    isFirebaseConnected = true;

                    // El inicio de sesión anónimo es CLAVE para la separación de datos
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                    
                    userIdDisplay.textContent = `ID de usuario: ${userId}`;
                    statusDisplay.textContent = 'Conectado a Firebase';
                    statusDisplay.classList.remove('text-yellow-600');
                    statusDisplay.classList.add('text-green-600');
                    console.log("User authenticated:", userId);

                    loadDataFromFirestore();
                } catch (e) {
                    console.error("Error initializing Firebase. Using local mode:", e);
                    // Si falla, el modo local es la única alternativa
                    initLocalMode();
                }
            } else {
                initLocalMode();
            }
            // Inicializa el selector de fecha y la fecha actual en la interfaz
            dateSelector.value = todayString;
            updateCurrentDate(); 
            setupEventHandlers();
        }

        /**
         * Initializes the application in local mode with mock data.
         */
        function initLocalMode() {
            isFirebaseConnected = false;
            userId = 'Sin ID de usuario';
            userIdDisplay.textContent = `ID temporal: ${crypto.randomUUID()}`; 
            statusDisplay.textContent = 'Modo Local (datos en memoria)';
            statusDisplay.classList.remove('text-green-600');
            statusDisplay.classList.add('text-yellow-600');
            
            allClassesData = {};
            for (const className in initialClassData) {
                allClassesData[className] = initialClassData[className].map(name => ({
                    name: name,
                    grades: [],
                    attendance: {},
                    observations: ''
                }));
            }
            loadingIndicator.style.display = 'none';
            currentClass = Object.keys(allClassesData)[0];
            students = allClassesData[currentClass];
            initializeClassSelector();
            renderStudentsTable();
        }
        
        /**
         * Loads data from Firestore and sets up a real-time listener.
         */
        function loadDataFromFirestore() {
            const docRef = getDataDocRef();
            
            onSnapshot(docRef, (docSnap) => {
                loadingIndicator.style.display = 'none';
                if (docSnap.exists() && docSnap.data().classes) {
                    allClassesData = docSnap.data().classes;
                    // Mantiene la clase seleccionada si existe
                    currentClass = currentClass || Object.keys(allClassesData)[0];
                    if (!allClassesData[currentClass] && Object.keys(allClassesData).length > 0) {
                         currentClass = Object.keys(allClassesData)[0];
                    }
                    students = allClassesData[currentClass] || [];
                    initializeClassSelector();
                    renderStudentsTable();
                } else {
                    console.log("No data found for this user, creating initial document.");
                    createInitialData();
                }
            }, (error) => {
                console.error("Error fetching Firestore document in real-time:", error);
                loadingIndicator.style.display = 'none';
                showMessage('Error de Sincronización', 'No se pudieron sincronizar los datos. Revisa la conexión o intenta recargar.');
            });
        }

        /**
         * Creates the initial data document in Firestore.
         */
        async function createInitialData() {
            try {
                const initialClasses = {};
                for (const className in initialClassData) {
                    initialClasses[className] = initialClassData[className].map(name => ({
                        name: name,
                        grades: [],
                        attendance: {},
                        observations: ''
                    }));
                }
                const docRef = getDataDocRef();
                await setDoc(docRef, { classes: initialClasses });
                console.log("Initial data created successfully for user:", userId);
            } catch (e) {
                console.error("Error creating initial data:", e);
                showMessage('Error de Creación', 'Hubo un problema al crear los datos iniciales. Revisa tus reglas de seguridad en Firebase.');
            }
        }
        
        /**
         * Saves the current application data to Firestore or local memory.
         * @async
         */
        async function saveData() {
            if (isFirebaseConnected) {
                try {
                    const docRef = getDataDocRef();
                    await updateDoc(docRef, { classes: allClassesData });
                    console.log("Data saved successfully to Firestore for user:", userId);
                    renderStudentsTable(); 
                } catch (e) {
                    console.error("Error saving data to Firestore:", e);
                    showMessage('Error de Guardado', 'No se pudieron guardar los datos. Revisa tu conexión y reglas de seguridad.');
                }
            } else {
                // Modo Local: Simplemente re-renderiza
                renderStudentsTable();
            }
        }

        // Función para mostrar un modal personalizado (sustituye a alert y confirm)
        function showMessage(title, message, isConfirm, callback) {
            // ... (Lógica del modal se mantiene igual)
            messageTitle.textContent = title;
            messageContent.textContent = message;
            okBtn.style.display = 'none';
            confirmBtn.style.display = 'none';
            cancelBtn.style.display = 'none';

            if (isConfirm) {
                confirmBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                confirmBtn.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback(true);
                };
                cancelBtn.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback(false);
                };
            } else {
                okBtn.style.display = 'block';
                okBtn.onclick = () => {
                    messageModal.style.display = 'none';
                    if (callback) callback();
                };
            }
            messageModal.style.display = 'flex';
        }

        // Función para renderizar la tabla de estudiantes
        function renderStudentsTable() {
            // ... (Lógica de la tabla se mantiene igual)
            if (!students || students.length === 0) {
                studentsTableContainer.innerHTML = '<p class="text-center text-gray-500">No hay estudiantes agregados en esta clase. ¡Agrega el primero!</p>';
                loadingIndicator.style.display = 'none'; 
                return;
            }
            
            const tableHtml = `
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Estudiante</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Notas</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Promedio</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Asistencia</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider no-print">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        ${students.map((student, index) => `
                            <tr class="border-t border-gray-200">
                                <td class="py-4 px-4 text-gray-800 font-medium">${student.name}</td>
                                <td class="py-4 px-4 text-gray-600">
                                    <div class="flex flex-wrap gap-2">
                                        ${(student.grades || []).map(grade => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${grade.toFixed(1)}</span>`).join('')}
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-lg font-bold text-blue-600">
                                    ${calculateAverage(student.grades).toFixed(1)}
                                </td>
                                <td class="py-4 px-4 text-lg">
                                    <span class="font-semibold text-sm px-2 py-1 rounded-full ${getAttendanceStatus(student).status === 'presente' ? 'bg-green-100 text-green-800' : getAttendanceStatus(student).status === 'ausente' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'}">
                                        ${getAttendanceStatus(student).status === 'presente' ? 'Presente' : getAttendanceStatus(student).status === 'ausente' ? 'Ausente' : 'N/A'}
                                    </span>
                                    <div class="mt-2 text-sm text-gray-500 italic">
                                        ${getAttendanceStatus(student).observation ? 'Obs: ' + getAttendanceStatus(student).observation : ''}
                                    </div>
                                </td>
                                <td class="py-4 px-4 no-print">
                                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                                        <button data-action="grade" data-index="${index}" class="text-blue-600 hover:text-blue-800 font-semibold text-sm whitespace-nowrap">Nota</button>
                                        <button data-action="attend" data-index="${index}" class="text-green-600 hover:text-green-800 font-semibold text-sm whitespace-nowrap">Asistencia</button>
                                        <button data-action="obs" data-index="${index}" class="text-purple-600 hover:text-purple-800 font-semibold text-sm whitespace-nowrap">Obs</button>
                                        <button data-action="delete" data-index="${index}" class="text-red-600 hover:text-red-800 font-semibold text-sm whitespace-nowrap">Eliminar</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            studentsTableContainer.innerHTML = tableHtml;
            setupStudentRowHandlers();
        }

        // ... (Funciones auxiliares para manejo de datos: handleAddStudent, initializeClassSelector, handleClassChange, handleDateChange, setupStudentRowHandlers, handleGradeInput, handleAttendanceInput, handleObservationClick, setupEventHandlers, generateClassReport, generateDetailedReport)

        // Manejador para agregar estudiante (se mantiene igual)
        function handleAddStudent() {
            const name = studentNameInput.value.trim().toUpperCase();
            if (name && currentClass) {
                if (!allClassesData[currentClass]) {
                    allClassesData[currentClass] = [];
                }
                const newStudent = { name: name, grades: [], attendance: {}, observations: '' };
                allClassesData[currentClass].push(newStudent);
                students = allClassesData[currentClass];
                studentNameInput.value = '';
                saveData();
            } else if (!currentClass) {
                showMessage('Clase Requerida', 'Por favor, selecciona o crea una clase primero.');
            }
        }

        // Inicializa el selector de clase (se mantiene igual)
        function initializeClassSelector() {
            classSelector.innerHTML = Object.keys(allClassesData).map(
                className => `<option value="${className}" ${className === currentClass ? 'selected' : ''}>${className}</option>`
            ).join('');
        }

        // Manejador de cambio de clase (se mantiene igual)
        function handleClassChange() {
            currentClass = classSelector.value;
            students = allClassesData[currentClass] || [];
            renderStudentsTable();
            viewMainTable();
        }

        // Manejador de cambio de fecha (se mantiene igual)
        function handleDateChange() {
            currentDateString = dateSelector.value;
            updateCurrentDate();
            renderStudentsTable();
        }

        // Configura los manejadores de eventos para la tabla (se mantiene igual)
        function setupStudentRowHandlers() {
            const body = document.getElementById('studentsTableBody');
            if (body) {
                body.onclick = (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        const action = button.dataset.action;
                        const index = parseInt(button.dataset.index);

                        if (action === 'grade') {
                            handleGradeInput(index);
                        } else if (action === 'attend') {
                            handleAttendanceInput(index);
                        } else if (action === 'obs') {
                            handleObservationClick(index);
                        } else if (action === 'delete') {
                            handleDeleteStudent(index);
                        }
                    }
                };
            }
        }

        // Manejador de ingreso de nota (se mantiene igual)
        function handleGradeInput(index) {
            const student = students[index];
            showMessage('Ingresar Nota para ' + student.name, 'Introduce la nota (1.0 - 7.0). Separa las notas con comas. (Ej: 6.0, 5.5)', true, (confirmed) => {
                if (confirmed) {
                    const gradeStr = messageContent.querySelector('textarea, input').value;
                    const newGrades = gradeStr.split(',').map(g => parseFloat(g.trim())).filter(g => !isNaN(g) && g >= 1.0 && g <= 7.0);

                    if (newGrades.length > 0) {
                        student.grades = newGrades;
                        saveData();
                    } else if (gradeStr.trim() !== '') {
                        showMessage('Error de Nota', 'Por favor, introduce notas válidas entre 1.0 y 7.0.');
                    }
                }
            });
            // Reemplaza el contenido del mensaje con un input de texto para la nota
            messageContent.innerHTML = `<input type="text" id="gradeInput" value="${student.grades.join(', ')}" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2">`;
        }

        // Manejador de asistencia (se mantiene igual)
        function handleAttendanceInput(index) {
            const student = students[index];
            const currentStatus = getAttendanceStatus(student).status;
            let newStatus;
            let message;

            if (currentStatus === 'presente') {
                newStatus = 'ausente';
                message = `¿Confirmas marcar a ${student.name} como **AUSENTE** el ${currentDateString}?`;
            } else {
                newStatus = 'presente';
                message = `¿Confirmas marcar a ${student.name} como **PRESENTE** el ${currentDateString}?`;
            }

            showMessage('Cambiar Asistencia', message, true, (confirmed) => {
                if (confirmed) {
                    if (!student.attendance) student.attendance = {};
                    if (!student.attendance[currentDateString]) {
                         student.attendance[currentDateString] = { status: newStatus, observation: '' };
                    } else {
                        student.attendance[currentDateString].status = newStatus;
                    }
                    saveData();
                }
            });
        }

        // Manejador de eliminación de estudiante (se mantiene igual)
        function handleDeleteStudent(index) {
             const student = students[index];
             showMessage('Confirmar Eliminación', `¿Estás seguro de eliminar a ${student.name} de ${currentClass}? Esta acción es permanente.`, true, (confirmed) => {
                if (confirmed) {
                    allClassesData[currentClass].splice(index, 1);
                    students = allClassesData[currentClass];
                    saveData();
                }
             });
        }

        // Manejador del modal de observación (se mantiene igual)
        function handleObservationClick(index) {
            currentStudentIndex = index;
            const student = students[index];
            modalTitle.textContent = `Observaciones para ${student.name} (${currentDateString})`;
            
            const attendanceRecord = getAttendanceStatus(student);
            observationTextarea.value = attendanceRecord.observation || '';
            
            observationModal.style.display = 'flex';
        }

        // Manejador de vistas (se mantiene igual)
        function viewMainTable() {
            studentsTableContainer.classList.remove('hidden');
            classReportContainer.classList.add('hidden');
            classDetailsContainer.classList.add('hidden');
        }

        // Generar reporte de clases (se mantiene igual)
        function generateClassReport() {
            viewReportView();
            let reportHtml = `
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-md">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Clase</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider">Estudiantes</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-700 uppercase tracking-wider no-print">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const className in allClassesData) {
                const classStudents = allClassesData[className];
                reportHtml += `
                    <tr class="border-t border-gray-200">
                        <td class="py-4 px-4 text-gray-800 font-medium">${className}</td>
                        <td class="py-4 px-4 text-gray-600">${classStudents.length}</td>
                        <td class="py-4 px-4 no-print">
                            <button data-action="view-details" data-class="${className}" class="bg-blue-500 text-white font-bold py-1 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors text-sm">Ver Detalle</button>
                        </td>
                    </tr>
                `;
            }

            reportHtml += `</tbody></table>`;
            classReportContent.innerHTML = reportHtml;
        }

        // Generar reporte detallado (se mantiene igual)
        function generateDetailedReport(className) {
            viewDetailsView();
            classDetailsTitle.textContent = `Detalle de Asistencia y Notas: ${className}`;
            const classStudents = allClassesData[className];

            if (!classStudents || classStudents.length === 0) {
                classDetailsContent.innerHTML = '<p class="text-center text-gray-500">No hay datos de estudiantes para esta clase.</p>';
                return;
            }

            // Identificar todas las fechas de asistencia
            const allDates = new Set();
            classStudents.forEach(student => {
                if (student.attendance) {
                    Object.keys(student.attendance).forEach(date => allDates.add(date));
                }
            });
            const sortedDates = Array.from(allDates).sort();

            let detailsHtml = `
                <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-md text-sm">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-2 text-left font-semibold text-gray-700 uppercase tracking-wider sticky left-0 bg-gray-200">Estudiante</th>
                            <th class="py-3 px-2 text-left font-semibold text-gray-700 uppercase tracking-wider">Notas (Avg)</th>
                            ${sortedDates.map(date => `<th class="py-3 px-2 text-center font-semibold text-gray-700 uppercase tracking-wider whitespace-nowrap">${new Date(date).toLocaleDateString('es-ES', { month: 'numeric', day: 'numeric' })}</th>`).join('')}
                            <th class="py-3 px-2 text-center font-semibold text-gray-700 uppercase tracking-wider">Obs. General</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            classStudents.forEach(student => {
                const average = calculateAverage(student.grades).toFixed(1);
                detailsHtml += `
                    <tr class="border-t border-gray-200">
                        <td class="py-2 px-2 text-gray-800 font-medium sticky left-0 bg-white">${student.name}</td>
                        <td class="py-2 px-2 text-center font-bold ${average >= 4.0 ? 'text-green-600' : (average > 0 ? 'text-red-600' : 'text-gray-500')}">${average}</td>
                        ${sortedDates.map(date => {
                            const record = student.attendance ? student.attendance[date] : null;
                            const status = record ? record.status : 'N/A';
                            const observation = record ? record.observation : '';
                            let statusClass = 'bg-gray-100 text-gray-600';
                            let statusText = status;
                            
                            if (status === 'presente') { statusClass = 'bg-green-100 text-green-800'; statusText = 'P'; }
                            else if (status === 'ausente') { statusClass = 'bg-red-100 text-red-800'; statusText = 'A'; }

                            const obsTitle = observation ? `title="${observation}"` : '';
                            return `<td class="py-2 px-2 text-center"><span class="font-semibold px-2 py-0.5 rounded-full ${statusClass}" ${obsTitle}>${statusText}</span></td>`;
                        }).join('')}
                        <td class="py-2 px-2 text-gray-600 text-xs">${student.observations.substring(0, 50)}...</td>
                    </tr>
                `;
            });

            detailsHtml += `</tbody></table></div>`;
            classDetailsContent.innerHTML = detailsHtml;
        }

        // Manejador de vistas de reporte (se mantiene igual)
        function viewReportView() {
            studentsTableContainer.classList.add('hidden');
            classDetailsContainer.classList.add('hidden');
            classReportContainer.classList.remove('hidden');
        }

        function viewDetailsView() {
            studentsTableContainer.classList.add('hidden');
            classReportContainer.classList.add('hidden');
            classDetailsContainer.classList.remove('hidden');
        }

        // --- Manejadores de Eventos ---

        function setupEventHandlers() {
            addStudentBtn.onclick = handleAddStudent;
            studentNameInput.onkeyup = (e) => {
                if (e.key === 'Enter') handleAddStudent();
            };
            classSelector.onchange = handleClassChange;
            dateSelector.onchange = handleDateChange;
            closeObservationModalBtn.onclick = () => observationModal.style.display = 'none';
            closeMessageModalBtn.onclick = () => messageModal.style.display = 'none';

            saveObservationBtn.onclick = () => {
                const observation = observationTextarea.value.trim();
                const student = students[currentStudentIndex];
                if (student) {
                    if (!student.attendance) student.attendance = {};
                    if (!student.attendance[currentDateString]) {
                         student.attendance[currentDateString] = { status: 'N/A', observation: '' };
                    }
                    student.attendance[currentDateString].observation = observation;
                    saveData();
                }
                observationModal.style.display = 'none';
            };

            // Manejadores para la impresión y reportes
            printCurrentViewBtn.onclick = () => window.print();
            generateReportBtn.onclick = () => generateClassReport();
            printReportBtn.onclick = () => window.print();
            printDetailsBtn.onclick = () => window.print();

            hideReportBtn.onclick = () => {
                viewMainTable();
            };

            backToReportBtn.onclick = () => {
                viewReportView();
            };

            // Manejador de clic para los botones "Ver Detalle" en el reporte
            classReportContainer.onclick = (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.action === 'view-details') {
                    const className = button.dataset.class;
                    generateDetailedReport(className);
                }
            };
        }

        // Inicia la aplicación al cargar la página
        window.onload = initApp;
    </script>
</body>
</html>